<!DOCTYPE html>
<html><head>
<title>lessons 10 through 12</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://cloud-fundis.github.io/scss/journal.min.56b67b8b01d7cd1015ed14414fd2fc33ebfb2e8413dcbc47c5cd734544c92cd7.css" integrity="sha256-VrZ7iwHXzRAV7RRBT9L8M&#43;v7LoQT3LxHxc1zRUTJLNc=" media="screen">



<link rel="stylesheet" href="https://cloud-fundis.github.io/scss/dark-mode.min.588bcae26a454daa76882866d3ccdf4ca1c9a0c7ce2159ac69108792f0aa8422.css" integrity="sha256-WIvK4mpFTap2iChm08zfTKHJoMfOIVmsaRCHkvCqhCI=" media="screen">


<script src="https://cloud-fundis.github.io//js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

<script src="https://cloud-fundis.github.io//js/table.js"></script>




<script src="https://cloud-fundis.github.io//js/toc.js"></script>








</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://cloud-fundis.github.io/">
    
        <div class="nav-title">
            because there are just too many things to remember
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/blog">
                Blogs
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About
            </a>
            
        
            
            
            
                
            
            
            <parent name="Lessons" type="nav-link-item active">
                
                    <li><a href="/lessons/jq"> jq</a></li>
                
            </parent>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 because there are just too many things to remember
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#last-time-on-jq-lessons-jq-jq3" v-on:click="closeDrawer" id="last-time-on-jq-lessons-jq-jq3-nav">
										 last time on jq
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-10" v-on:click="closeDrawer" id="lesson-10-nav">
										 Lesson 10
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#using-functions" v-on:click="closeDrawer" id="using-functions-nav">
										 Using functions
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#join" v-on:click="closeDrawer" id="join-nav">
										 join
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#contains" v-on:click="closeDrawer" id="contains-nav">
										 contains
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#sub" v-on:click="closeDrawer" id="sub-nav">
										 sub
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-11" v-on:click="closeDrawer" id="lesson-11-nav">
										 Lesson 11
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#reading-your-jq-from-a-file" v-on:click="closeDrawer" id="reading-your-jq-from-a-file-nav">
										 Reading your jq from a file
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-12" v-on:click="closeDrawer" id="lesson-12-nav">
										 Lesson 12
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#if-then-else" v-on:click="closeDrawer" id="if-then-else-nav">
										 If-then-else
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/blog">
                    Blogs
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
                
                
                
                    
                
                
                <parent name="Lessons" type="drawer-menu-item active">
                    
                        <li><a href="/lessons/jq"> jq</a></li>
                    
                </parent>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#last-time-on-jq-lessons-jq-jq3" v-on:click="closeDrawer" id="last-time-on-jq-lessons-jq-jq3-nav">
										 last time on jq
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-10" v-on:click="closeDrawer" id="lesson-10-nav">
										 Lesson 10
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#using-functions" v-on:click="closeDrawer" id="using-functions-nav">
										 Using functions
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#join" v-on:click="closeDrawer" id="join-nav">
										 join
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#contains" v-on:click="closeDrawer" id="contains-nav">
										 contains
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#sub" v-on:click="closeDrawer" id="sub-nav">
										 sub
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-11" v-on:click="closeDrawer" id="lesson-11-nav">
										 Lesson 11
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#reading-your-jq-from-a-file" v-on:click="closeDrawer" id="reading-your-jq-from-a-file-nav">
										 Reading your jq from a file
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#lesson-12" v-on:click="closeDrawer" id="lesson-12-nav">
										 Lesson 12
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#if-then-else" v-on:click="closeDrawer" id="if-then-else-nav">
										 If-then-else
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://cloud-fundis.github.io/">
            because there are just too many things to remember
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://cloud-fundis.github.io/">
        <div class="single-column-header-title">because there are just too many things to remember</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('https://cloud-fundis.github.io/')">
                <div class="post-title">
                    lessons 10 through 12
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-05-12 16:20
                        </time>
                        

                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/jq">jq</a>
                                &nbsp;
                            
                                <a href="/tags/json">json</a>
                                &nbsp;
                            
                                <a href="/tags/shell">shell</a>
                                &nbsp;
                            
                                <a href="/tags/functions">functions</a>
                                &nbsp;
                            
                                <a href="/tags/comments">comments</a>
                                &nbsp;
                            
                                <a href="/tags/read-from-file">read-from-file</a>
                                &nbsp;
                            
                                <a href="/tags/conditionals">conditionals</a>
                                &nbsp;
                            
                                <a href="/tags/aws-events">aws-events</a>
                                &nbsp;
                            
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    

<h1 id="last-time-on-jq-lessons-jq-jq3"><a href="/lessons/jq/jq3">last time on jq</a></h1>

<p>Another way of producing a text list of running instances may be to push the fields we want though another <em>jq</em> function - join.</p>

<h2 id="lesson-10">Lesson 10</h2>

<h3 id="using-functions">Using functions</h3>

<p>There are a number of useful functions in <em>jq</em> that will make life a little easier. Let&rsquo;s explore some of them.</p>

<h4 id="join">join</h4>

<p>A function to join an array into a string. Whereas before we created a string using String iterpolation, we could simply use join.</p>

<pre><code>jq '.Reservations[].Instances[]|select(.State.Name == &quot;running&quot;) | [.LaunchTime, .InstanceId, .State.Name, .PrivateIpAddress, .BlockDeviceMappings[].Ebs.Status, .BlockDeviceMappings[].DeviceName, .BlockDeviceMappings[].Ebs.VolumeId]| join(&quot;,&quot;)'
</code></pre>

<p>produces a nice string as before, just a little more easily. You should note though that the fields in this example are all in a single string; not multiple strings as before.</p>

<pre><code>&quot;2020-05-13T03:45:33.000Z,i-053667d4e26795541,running,172.16.2.26,attached,/dev/sda1,vol-05dec31f2e74067b0&quot;
&quot;2020-05-13T03:50:44.000Z,i-0a775b8c631e8ad27,running,172.16.2.15,attached,/dev/sda1,vol-01ca741dc26d7c0f9&quot;
&quot;2020-05-13T03:50:44.000Z,i-061b358b9cfc20505,running,172.16.1.13,attached,/dev/sda1,vol-0610ab7fde8c71943&quot;
</code></pre>

<p>Notice too, that in order to use join, we need to supply it with an array. Hence my fields are enclosed in square ( [ ] ) braces turning the output into an array. This array is consumed by the <em>join</em> function.</p>

<h4 id="contains">contains</h4>

<p>To change tack slightly, we look at the events rules that have been configured. Event rules are set up in the CloudWatch console but are referred to as events in the AWS CLI.</p>

<p>Suppose I have a number of rules, and I only want to select those that contain the description &ldquo;Stop&rdquo;.</p>

<pre><code>aws events list-rules | jq '.Rules[]|select(.Description|contains(&quot;Stop&quot;))'
</code></pre>

<p>Here we&rsquo;re using two functions: <em>select</em> and <em>contains</em>.</p>

<pre><code>{
  &quot;Name&quot;: &quot;STOP_client_servers&quot;,
  &quot;Arn&quot;: &quot;arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/STOP_client_servers&quot;,
  &quot;State&quot;: &quot;ENABLED&quot;,
  &quot;Description&quot;: &quot;Stop servers that are prod for client servers: CRM, OpenVPN server&quot;,
  &quot;ScheduleExpression&quot;: &quot;cron(30 15 ? * 2-6 *)&quot;,
  &quot;EventBusName&quot;: &quot;default&quot;
}
{
  &quot;Name&quot;: &quot;Stop_client_DC01&quot;,
  &quot;Arn&quot;: &quot;arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/Stop_client_DC01&quot;,
  &quot;State&quot;: &quot;ENABLED&quot;,
  &quot;Description&quot;: &quot;Stop the client Active Domain Controller when not being used&quot;,
  &quot;ScheduleExpression&quot;: &quot;cron(40 15 ? * 2-6 *)&quot;,
  &quot;EventBusName&quot;: &quot;default&quot;
}
</code></pre>

<h4 id="sub">sub</h4>

<p>Substitute is useful for strings; substituting <em>this</em> for <em>that</em>.</p>

<p>In the following one, I want to substitue x&rsquo;s for the customer account number from the .Arn and I also want to remove the customer name from all .Descriptions and .Names</p>

<pre><code>jq -rc '.Rules[]|[.Name, .Arn, .State, .Description]|join(&quot;,&quot;)|sub(&quot;CDLI&quot;;&quot;client&quot;;&quot;g&quot;)|sub(&quot;182306120021&quot;;&quot;xxxxxxxxxxxx&quot;;&quot;g&quot;)'
</code></pre>

<pre><code>START_client_servers,arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/START_client_servers,ENABLED,Start client prod servers: CRM &amp; OpenVPN server
STOP_client_servers,arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/STOP_client_servers,ENABLED,Stop servers that are prod for client servers: CRM, OpenVPN server
Start_client_DC01,arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/Start_client_DC01,ENABLED,Start the client Active Domain Controller
Stop_client_DC01,arn:aws:events:eu-west-1:xxxxxxxxxxxx:rule/Stop_client_DC01,ENABLED,Stop the client Active Domain Controller when not being used
</code></pre>

<p>Of course these things can get really difficult to read as they grow.</p>

<pre><code>jq -rc '.Rules[]|select(.Description|contains(&quot;Stop&quot;))|[.Name, .Arn, .State, .Description]|join(&quot;,&quot;)|sub(&quot;CDLI&quot;;&quot;client&quot;;&quot;g&quot;)|sub(&quot;182306120021&quot;;&quot;xxxxxxxxxxxx&quot;;&quot;g&quot;)'
</code></pre>

<p>Here we&rsquo;re combining the select and using sub twice as above.</p>

<h2 id="lesson-11">Lesson 11</h2>

<h3 id="reading-your-jq-from-a-file">Reading your <em>jq</em> from a file</h3>

<p>To make the <em>jq</em> script easier to manage (and of course reuse), it&rsquo;s often worth putting the script in a file and calling it using the <em>from-file</em> ( -f ) flag. What makes this great is that now you can use newlines and set out your <em>jq</em> in a much easier-to-read format.</p>

<p>Note however, that when doing this, you&rsquo;ll need to leave off the single quotes ( &lsquo; ) around your <em>jq</em> command.</p>

<p>Re-writing the above <em>jq</em> it would look like this in our file test.jq</p>

<pre><code>.Rules[]
    | select(.Description
        | contains(&quot;Stop&quot;))
    | [.Name, .Arn, .State, .Description]
    | join(&quot;,&quot;)
    | sub(&quot;CDLI&quot;;&quot;client&quot;;&quot;g&quot;)
    | sub(&quot;182306120021&quot;;&quot;xxxxxxxxxxxx&quot;;&quot;g&quot;)
</code></pre>

<p>Now running <em>jq</em> is easier with:</p>

<pre><code>aws events list-rules | jq -f test.jq
</code></pre>

<p>What makes this even more appealing is that you can use comments (everything after a # is a comment) in your <em>jq</em> script now as follows:</p>

<pre><code># Grab the details of stop events from the aws event log
# use as: aws events list-rules | jq -f &lt;filename.jq&gt;

.Rules[]
    | select(.Description
        | contains(&quot;Stop&quot;))                     # From the rules, only select those where .Description contains the word &quot;Stop&quot;
    | [.Name, .Arn, .State, .Description]       # Keep only the .Name, .Arn, .State and .Description. Remember to make as an array
    | join(&quot;,&quot;)                                 # Join the array with commas
    | sub(&quot;CDLI&quot;;&quot;client&quot;;&quot;g&quot;)                  # Remove the client name replacing with &quot;client&quot;
    | sub(&quot;182306120021&quot;;&quot;xxxxxxxxxxxx&quot;;&quot;g&quot;)    # Remove the account number from .Arn
</code></pre>

<p>From this you will notice that white-space has no effect on the expression. This means we can indent the various parts of the <em>jq</em> expression to make it even more legible. Additionally we like to put a comment at the top of the file to give</p>

<ul>
<li>some indication of how to use this <em>jq</em> expression and</li>
<li>to give details of what it does</li>
</ul>

<p>Finally, it may be worth naming the files intelligently. While you may think you&rsquo;ll never use this &ldquo;once-off&rdquo; expression again, this is almost certainly not true - you will reuse it. Or at least you&rsquo;ll remember that you used something in it that made sense at the time.</p>

<p>We name our files like this:</p>

<pre><code>events.rules.jq
</code></pre>

<p>and store them in a directory structure similar to our shell, Python, Scala and other scripts. Spending a little time in the beginning will save you oodles of time later.</p>

<p>For the rest of the series we&rsquo;ll be using <em>jq</em> scripts in this form: as if they&rsquo;re part of a file with comments.</p>

<h2 id="lesson-12">Lesson 12</h2>

<h3 id="if-then-else">If-then-else</h3>

<p>Of course every language has boolean conditionals; <em>jq</em> is no exception.</p>

<p>Where we&rsquo;ve found this most useful is in switching a variable, from say &ldquo;done: False&rdquo; to &ldquo;done: True&rdquo;. Most recently we had a DynamoDB table where we had just such a key:value pair. Wanting to switch all entries from &ldquo;shouldRun: False&rdquo; to &ldquo;shouldRun: True&rdquo;.</p>

<p>Before we get there however, let&rsquo;s take a step back. Using if-then-else-end to mark instances that are in a &lsquo;running&rsquo; state with an &lsquo;R&rsquo; while instances in a &lsquo;stopped&rsquo; state with an &rsquo;S&rsquo;.</p>

<pre><code>.Reservations[].Instances[]
    | select(.State.Name == &quot;running&quot; or .State.Name == &quot;stopped&quot;)
    | [.LaunchTime, .InstanceId, if .State.Name == &quot;running&quot; then &quot;R&quot; else &quot;S&quot; end, 
       .PrivateIpAddress, 
       ( .BlockDeviceMappings[]
            | .DeviceName, .Ebs.Status, .Ebs.VolumeId ) ]   # Notice how I split these things up to make it
                                                            # more meaningful
    | join(&quot;,&quot;)
</code></pre>

<p>Ok, we&rsquo;ve jumped ahead here a bit showing multiple things at once. Let&rsquo;s tackle these things one at a time.</p>

<p>First notice the round braces ( () ) around the <em>.BlockDeviceMappings</em> array. This allows us to treat the <em>.BlockDeviceMappings</em> almost independently of the other JSON objects in the array we&rsquo;re building.</p>

<p>As an alternative to using the round braces, we could have done this:</p>

<pre><code>        ...
           .BlockDeviceMappings[].DeviceName,
           .BlockDeviceMappings[].Ebs.Status,
           .BlockDeviceMappings[].Ebs.VolumeId 
        ...
</code></pre>

<p>but that&rsquo;s just so verbose. Instead enclosing <em>.BlockDeviceMappings</em> inside the braces and then applying a pipe to it&rsquo;s output, thereby selecting only the keys we&rsquo;re after.</p>

<p>So much nicer.</p>

<p>Comments add a lot of value, expecially later when you come back to try and figure out what you were up to. Note here that because white-space is ignored, we can run comments over multiple lines. Very handy indeed.</p>

<p>Finally the if statement</p>

<p>The way this works is that there must be an <em>if - then - else - end</em>. You cannot leave off the else or the end.</p>

<p>In this case, we&rsquo;re testing whether the <em>.State.Name</em> is &ldquo;running&rdquo; and if it is, replace the current <em>.State.Name</em> with an &ldquo;R&rdquo;, otherwise I replace it with an &ldquo;S&rdquo;. Notice how to include this in the list as if it&rsquo;s a regular element.</p>

<pre><code>&quot;2020-05-13T03:45:33.000Z,i-053667d4e26795541,R,172.16.2.26,/dev/sda1,attached,vol-05dec31f2e74067b0&quot;
&quot;2020-05-13T03:50:44.000Z,i-0a775b8c631e8ad27,R,172.16.2.15,/dev/sda1,attached,vol-01ca741dc26d7c0f9&quot;
&quot;2020-04-23T12:37:54.000Z,i-06e986e85261c838e,S,172.16.1.10,/dev/sda1,attached,vol-01a80015424546dad&quot;
&quot;2020-05-13T03:50:44.000Z,i-061b358b9cfc20505,R,172.16.1.13,/dev/sda1,attached,vol-0610ab7fde8c71943&quot;
</code></pre>

<p>Exactly what we&rsquo;re after.</p>

<p>For completeness, we&rsquo;ve called this file running.jq and placed it in the directory:</p>

<pre><code>../programming/jq/aws/
├── ec2
│   └── running.jq          &lt;----- here it is...
└── events
    └── events.rules.jq
</code></pre>

<p>and call it like this:</p>

<pre><code>aws ec2 describe-instances --profile cust --region eu-west-1 | jq -f ../programming/jq/aws/ec2/running.jq
</code></pre>

<p>Of course we promised to show you how we change &ldquo;shouldRun: False&rdquo; to &ldquo;shouldRun: True&rdquo; in the DynamoDB table. We&rsquo;ve done this in steps, but of course you could do it all in a single long command line. :-)</p>

<p>First dump the table to a JSON file:</p>

<pre><code>aws dynamodb get-item --table-name scriptTable --key &quot;{\&quot;scriptName\&quot;: {\&quot;S\&quot;: \&quot;message_table\&quot;}}&quot; --region eu-west-1 | jq -j '.' &gt; message_table.getitem
</code></pre>

<p>This yield a file for the table looking like this (truncated for brevity):</p>

<pre><code>{
    &quot;Item&quot;: {
        &quot;lastRun&quot;: {
            &quot;N&quot;: &quot;0&quot;
        }, 
        &quot;shouldRun&quot;: {
            &quot;BOOL&quot;: false
        }, 
        &quot;startAt&quot;: {
            &quot;N&quot;: &quot;0&quot;
        }, 
        &quot;description&quot;: {
            &quot;S&quot;: &quot;A script to extract data from the message table on DB&quot;
        }, 
        &quot;lambda&quot;: {
            &quot;S&quot;: &quot;livyLambda&quot;
        }, 
        &quot;clusterID&quot;: {
            &quot;S&quot;: &quot;j-2EIPAI8VW80O&quot;
        }, 
    ...
</code></pre>

<p>We want to switch the &ldquo;false&rdquo; in <em>shouldRun</em> to &ldquo;true&rdquo;</p>

<p>Now we can apply a <em>jq</em> expression to do that:</p>

<p>jq &ldquo;if ( .Item.shouldRun ) then .Item.shouldRun={\&ldquo;BOOL\&rdquo;: true } else . end&rdquo; message_table.getitem &gt; message_table.putitem</p>

<p>Taking the resulting file and pushing that back to DynamoDB will do what we&rsquo;re after:</p>

<pre><code>jq '.Item' message_table.putitem &gt; new.json &amp;&amp; aws dynamodb put-item --table-name scriptTable --item file:///home/hadoop/new.json
</code></pre>

<p>Done. Your DynamoDB table has been updated with the &ldquo;shouldRun&rdquo; set to True.</p>

<p>As easy as that.</p>

<p>Tjoef-tjaf.</p>

<p>Thanks to @Wendy for the inspiration of the events rules.</p>

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-05-12</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
                    Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="https://cloud-fundis.github.io/lessons/jq/jq3/">
                    Previous<br>jq getting interesting: lessons 7 through 9
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                






            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 because there are just too many things to remember
	</div>
    	</div>
    <script src="https://cloud-fundis.github.io//js/journal.js"></script>
    </body>
</html>
